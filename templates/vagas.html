{% extends "base.html" %}
{% block conteudo %}
<h2 style="margin-bottom:20px;">Oportunidades para mim</h2>

<div style="display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start;">

  <!-- FILTROS -->
  <aside style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.05);">
    <h3 style="margin-bottom:15px;font-size:18px;color:#333;">üîé Procurar Oportunidades</h3>

    <form method="GET" id="form-filtros" action="{{ url_for('pagina_vagas') }}">
      <div style="margin-bottom:12px;">
        <input type="text" name="q" value="{{ filtros.q }}" placeholder="Pesquisar por t√≠tulo ou descri√ß√£o..."
               style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
      </div>

      <!-- Cidade -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Cidade</label>
        <select name="cidade" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todas --</option>
          {% for c in cidades %}
            <option value="{{ c }}" {% if filtros.cidade==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Categoria -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Categoria</label>
        <select name="categoria" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todas --</option>
          {% for cat in categorias %}
            <option value="{{ cat }}" {% if filtros.categoria==cat %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Empresa -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Empresa</label>
        <select name="empresa" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todas --</option>
          {% for e in empresas %}
            <option value="{{ e }}" {% if filtros.empresa==e %}selected{% endif %}>{{ e }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- Hor√°rio -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Hor√°rio</label>
        <select name="horario" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todos --</option>
          <option value="full-time" {% if filtros.horario=='full-time' %}selected{% endif %}>Full-time</option>
          <option value="part-time" {% if filtros.horario=='part-time' %}selected{% endif %}>Part-time</option>
          <option value="remoto" {% if filtros.horario=='remoto' %}selected{% endif %}>Remoto</option>
        </select>
      </div>

      <!-- Tipo -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Tipo</label>
        <select name="tipo" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todos --</option>
          <option value="emprego" {% if filtros.tipo=='emprego' %}selected{% endif %}>Emprego</option>
          <option value="estagio" {% if filtros.tipo=='estagio' %}selected{% endif %}>Est√°gio</option>
          <option value="bolsa" {% if filtros.tipo=='bolsa' %}selected{% endif %}>Bolsa</option>
        </select>
      </div>

      <!-- Natureza -->
      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Natureza</label>
        <select name="natureza" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todas --</option>
          <option value="interna" {% if filtros.natureza=='interna' %}selected{% endif %}>Interna</option>
          <option value="externa" {% if filtros.natureza=='externa' %}selected{% endif %}>Externa</option>
        </select>
      </div>
    </form>

    <p style="margin-top:15px;font-size:14px;color:#555;">Resultado: <b id="total-vagas"></b></p>
  </aside>

  <!-- LISTAGEM DE VAGAS -->
  <section id="lista-vagas" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">
    <!-- preenchido dinamicamente pelo JS -->
  </section>
</div>

<script>
// ===== BUSCA EM TEMPO REAL DAS VAGAS =====
const formFiltros = document.getElementById("form-filtros");
const listaVagas = document.getElementById("lista-vagas");
const totalVagas = document.getElementById("total-vagas");

async function carregarVagas() {
  const params = new URLSearchParams(new FormData(formFiltros));
  const resp = await fetch(`/api/vagas?${params.toString()}`);
  const dados = await resp.json();

  listaVagas.innerHTML = "";
  totalVagas.textContent = dados.length;

  if (dados.length === 0) {
    listaVagas.innerHTML = `<p style="color:#777;font-size:14px;">Nenhuma vaga encontrada.</p>`;
    return;
  }

  dados.forEach(v => {
    const card = document.createElement("div");
    card.style = "background:#fff;border:1px solid #ddd;border-radius:10px;padding:15px;margin-bottom:10px;" +
                 "box-shadow:0 2px 6px rgba(0,0,0,.05);transition:all .25s ease;cursor:pointer;overflow:hidden;";
    card.onmouseover = () => { card.style.transform="translateY(-5px)"; card.style.boxShadow="0 8px 16px rgba(0,0,0,0.15)"; };
    card.onmouseout  = () => { card.style.transform="translateY(0)";    card.style.boxShadow="0 2px 6px rgba(0,0,0,.05)"; };

    card.innerHTML = `
      <a href="${v.link}" ${v.externa ? 'target="_blank"' : ''} style="text-decoration:none;color:inherit;">
        <img src="${v.imagem}" alt="Imagem da vaga"
             style="width:100%;height:140px;object-fit:cover;border-radius:6px;margin-bottom:10px;">
        <span style="display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700;
                     color:#fff;background:${v.externa ? "#2ba656" : "#882bbf"};margin-bottom:8px;">
          ${v.externa ? "Vaga Externa" : "Vaga Interna"}
        </span>
        <h3 style="margin:10px 0;font-size:17px;color:#333;line-height:1.3;">${v.titulo}</h3>
        ${v.categoria ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Categoria:</b> ${v.categoria}</p>` : ""}
        ${v.cidade ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Cidade:</b> ${v.cidade}</p>` : ""}
        ${v.horario ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Hor√°rio:</b> ${v.horario}</p>` : ""}
        ${v.tipo ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Tipo:</b> ${v.tipo}</p>` : ""}
        <p style="margin-top:8px;font-size:13px;color:#444;">${v.descricao}</p>
      </a>

      <!-- BOT√ÉO FAVORITAR -->
      <form method="POST" action="/favoritar/${v.id}" style="margin-top:10px;text-align:right;">
        <button type="submit"
                style="background:none;border:none;cursor:pointer;font-size:18px;"
                title="Guardar vaga">
          ‚≠ê
        </button>
      </form>
    `;
    listaVagas.appendChild(card);
  });
}

// Atualiza em tempo real quando mudar qualquer campo
formFiltros.addEventListener("input", () => {
  carregarVagas();
});

// Carrega ao abrir p√°gina
carregarVagas();
</script>
{% endblock %}