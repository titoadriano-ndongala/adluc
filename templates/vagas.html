{% extends "base.html" %}
{% block conteudo %}
<h2 style="margin-bottom:20px;">Oportunidades para mim</h2>

<div style="display:grid;grid-template-columns:300px 1fr;gap:20px;align-items:start;">

  <!-- FILTROS -->
  <aside style="background:#fff;border:1px solid #ddd;border-radius:8px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,.05);">
    <h3 style="margin-bottom:15px;font-size:18px;color:#333;">üîé Procurar Oportunidades</h3>

    <form method="GET" id="form-filtros" action="{{ url_for('pagina_vagas') }}">
      <div style="margin-bottom:12px;">
        <input type="text" name="q" value="{{ filtros.q }}" placeholder="Pesquisar por t√≠tulo ou descri√ß√£o..."
               style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
      </div>

      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Cidade</label>
        <input type="text" name="cidade" value="{{ filtros.cidade }}" placeholder="Ex.: Lisboa"
               style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
      </div>

      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Categoria</label>
        <select name="categoria" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todas --</option>
          <option>Administra√ß√£o / Secretariado</option>
          <option>Agricultura / Florestas / Pescas</option>
          <option>Arquitectura / Design</option>
          <option>Artes / Entretenimento / Media</option>
          <option>Banca / Seguros / Servi√ßos Financeiros</option>
          <option>Beleza / Moda / Bem Estar</option>
          <option>Call Center / Help Desk</option>
          <option>Comercial / Vendas</option>
          <option>Comunica√ß√£o Social / Media</option>
          <option>Conserva√ß√£o / Manuten√ß√£o / T√©cnica</option>
          <option>Constru√ß√£o Civil</option>
          <option>Contabilidade / Finan√ßas</option>
          <option>Desporto / Gin√°sios</option>
          <option>Direito / Justi√ßa</option>
          <option>Educa√ß√£o / Forma√ß√£o</option>
          <option>Engenharia (Ambiente)</option>
          <option>Engenharia (Civil)</option>
          <option>Engenharia (Eletrot√©cnica)</option>
          <option>Engenharia (Mec√¢nica)</option>
          <option>Engenharia (Qu√≠mica / Biologia)</option>
          <option>Farm√°cia / Biotecnologia</option>
          <option>Gest√£o de Empresas / Economia</option>
          <option>Gest√£o RH</option>
          <option>Hotelaria / Turismo</option>
          <option>Imobili√°rio</option>
          <option>Ind√∫stria / Produ√ß√£o</option>
          <option>Inform√°tica (An√°lise de Sistemas)</option>
          <option>Inform√°tica (Forma√ß√£o)</option>
          <option>Inform√°tica (Gest√£o de Redes)</option>
          <option>Inform√°tica (Internet)</option>
          <option>Inform√°tica (Multim√©dia)</option>
          <option>Inform√°tica (Programa√ß√£o)</option>
          <option>Inform√°tica (T√©cnico de Hardware)</option>
          <option>Inform√°tica (Comercial / Gestor de Conta)</option>
          <option>Limpezas / Dom√©sticas</option>
          <option>Lojas / Com√©rcio / Balc√£o</option>
          <option>Publicidade / Marketing</option>
          <option>Rela√ß√µes P√∫blicas</option>
          <option>Restaura√ß√£o / Bares / Pastelarias</option>
          <option>Sa√∫de / Medicina / Enfermagem</option>
          <option>Servi√ßos Sociais</option>
          <option>Servi√ßos T√©cnicos</option>
          <option>Telecomunica√ß√µes</option>
          <option>Transportes / Log√≠stica</option>
        </select>
      </div>

      <div style="margin-bottom:12px;position:relative;">
        <label style="font-weight:600;font-size:14px;">Empresa</label>
        <input type="text" id="empresa-input" name="empresa" value="{{ filtros.empresa or '' }}"
               placeholder="Digite o nome da empresa"
               style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
        <div id="sugestoes-empresa"
             style="position:absolute;top:65px;left:0;width:100%;background:#fff;border:1px solid #ccc;border-radius:6px;
                    max-height:200px;overflow-y:auto;z-index:1000;display:none;"></div>
      </div>

      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Hor√°rio</label>
        <select name="horario" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todos --</option>
          <option value="full-time">Full-time</option>
          <option value="part-time">Part-time</option>
          <option value="remoto">Remoto</option>
        </select>
      </div>

      <div style="margin-bottom:12px;">
        <label style="font-weight:600;font-size:14px;">Tipo</label>
        <select name="tipo" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:6px;font-size:14px;">
          <option value="">-- Todos --</option>
          <option value="emprego">Emprego</option>
          <option value="estagio">Est√°gio</option>
          <option value="bolsa">Bolsa</option>
        </select>
      </div>
    </form>

    <p style="margin-top:15px;font-size:14px;color:#555;">Resultado: <b id="total-vagas">{{ total }}</b> vagas</p>
  </aside>

  <!-- LISTAGEM DE VAGAS -->
  <section id="lista-vagas" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;">
    <!-- preenchido dinamicamente pelo JS -->
  </section>
</div>

<script>
// ===== AUTOCOMPLETE DE EMPRESA =====
const input = document.getElementById("empresa-input");
const sugestoesBox = document.getElementById("sugestoes-empresa");

input.addEventListener("input", async () => {
  const termo = input.value.trim();
  if (termo.length < 2) {
    sugestoesBox.style.display = "none";
    return;
  }
  const resp = await fetch(`/api/empresas?q=${encodeURIComponent(termo)}`);
  const dados = await resp.json();

  if (dados.length === 0) {
    sugestoesBox.style.display = "none";
    return;
  }

  sugestoesBox.innerHTML = "";
  dados.forEach(emp => {
    const div = document.createElement("div");
    div.textContent = emp.nome;
    div.style.padding = "8px 10px";
    div.style.cursor = "pointer";
    div.onmouseover = () => div.style.background = "#f2f2f2";
    div.onmouseout = () => div.style.background = "#fff";
    div.onclick = () => {
      input.value = emp.nome;
      sugestoesBox.style.display = "none";
      carregarVagas(); // dispara atualiza√ß√£o imediata
    };
    sugestoesBox.appendChild(div);
  });
  sugestoesBox.style.display = "block";
});

// ===== BUSCA EM TEMPO REAL DAS VAGAS =====
const formFiltros = document.getElementById("form-filtros");
const listaVagas = document.getElementById("lista-vagas");
const totalVagas = document.getElementById("total-vagas");

async function carregarVagas() {
  const params = new URLSearchParams(new FormData(formFiltros));
  const resp = await fetch(`/api/vagas?${params.toString()}`);
  const dados = await resp.json();

  listaVagas.innerHTML = "";
  totalVagas.textContent = dados.length;

  if (dados.length === 0) {
    listaVagas.innerHTML = `<p style="color:#777;font-size:14px;">Nenhuma vaga encontrada.</p>`;
    return;
  }

  dados.forEach(v => {
    const card = document.createElement("a");
    card.href = v.link;
    if (v.externa) card.target = "_blank";
    card.style = "display:block;text-decoration:none;color:inherit;";

    card.innerHTML = `
      <div style="background:#fff;border:1px solid #ddd;border-radius:10px;padding:15px;
                  box-shadow:0 2px 6px rgba(0,0,0,.05);transition:all .25s ease;cursor:pointer;overflow:hidden;"
           onmouseover="this.style.transform='translateY(-5px)';this.style.boxShadow='0 8px 16px rgba(0,0,0,0.15)';"
           onmouseout="this.style.transform='translateY(0)';this.style.boxShadow='0 2px 6px rgba(0,0,0,.05)';">

        <img src="${v.imagem}" alt="Imagem da vaga"
             style="width:100%;height:140px;object-fit:cover;border-radius:6px;margin-bottom:10px;">

        <span style="display:inline-block;padding:4px 8px;border-radius:12px;font-size:12px;font-weight:700;
                     color:#fff;background:${v.externa ? "#0d6efd" : "#28a745"};margin-bottom:8px;">
          ${v.externa ? "Vaga Externa" : "Vaga Interna"}
        </span>

        <h3 style="margin:10px 0;font-size:17px;color:#333;line-height:1.3;">${v.titulo}</h3>

        ${v.categoria ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Categoria:</b> ${v.categoria}</p>` : ""}
        ${v.cidade ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Cidade:</b> ${v.cidade}</p>` : ""}
        ${v.horario ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Hor√°rio:</b> ${v.horario}</p>` : ""}
        ${v.tipo ? `<p style="margin:2px 0;font-size:13px;color:#555;"><b>Tipo:</b> ${v.tipo}</p>` : ""}

        <p style="margin-top:8px;font-size:13px;color:#444;">${v.descricao}</p>
      </div>
    `;
    listaVagas.appendChild(card);
  });
}

// Atualiza em tempo real quando mudar qualquer campo
formFiltros.addEventListener("input", () => {
  carregarVagas();
});

// Carrega ao abrir p√°gina
carregarVagas();
</script>
{% endblock %}
